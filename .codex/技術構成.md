# 技術構成

## 技術スタック
- **UI**: React + TypeScript + Vite
- **描画**: SVG（盤面・石・演出）。CSSでレイアウト/微アニメーション
- **状態管理**: React Hooks（各モード専用のコンポーネントで管理）
- **タイマー**: `use-timer`（リプレイのステップ再生に使用）
- **ルーティング**: URL クエリによるモード切替（簡易ルーター）

## モード構成
- **GameRoot**: URL を読み取り、`PlayElement`（通常対局）または `ReplayElement`（リプレイ）を表示
- **PlayElement**: 人間入力 + AI手番、パス/終了判定、終了画面でリプレイURL発行
- **ReplayElement**: ログに基づき0.5秒間隔（既定）で自動再生。終了後は通常の終了画面

## URL パラメータ仕様
- `replay=1`: リプレイモードで起動
- `player`: `1`（先手=黒） or `-1`（後手=白）
- `level`: `0..6`（AI強さ）
- `log`: 置いたセル index の列。区切りは `.`（例: `1.43.12`）
- リプレイ終了/NEW GAME時は `replay/player/level/log` を URL から除去

## 主要ディレクトリ/ファイル
- `src/components/GameRoot.tsx`: モード切替の親
- `src/components/PlayElement.tsx`: 通常対局の本体
- `src/components/ReplayElement.tsx`: リプレイの本体（`use-timer`駆動）
- `src/components/FieldElement.tsx`: 盤面（SVG）。クリックでセル座標を算出
- `src/components/CellElement.tsx`: セル/石の描画（数値/メダルリング/アニメ付き）
- `src/components/ScoreElement.tsx`: スコア表示
- `src/components/StartOverlay.tsx`: ルール表示の開始オーバーレイ
- `src/components/EndOverlay.tsx`: 終了画面（NEW GAME=紫, REPLAY=オレンジ）
- `src/components/ReplayOverlay.tsx`: リプレイ中オーバーレイ（青ティント + 走査線 + ▶）
- `src/components/panels/*`: 下部パネル（設定/対局中/終了後）と `AiAvatar`
- `src/model/Field.ts`: 盤面モデル（不変オブジェクト）
- `src/ai/AlphaBeta.ts`: AI（α-β / Greedy、評価関数）
- `src/lib/*`: 純粋関数群（色変換/ラベル/盤面補助/評価補助/URL/リプレイ）

## 盤面モデルとルール
- **型**: `Cell = number`
  - `0`: 空、`>0`: 黒、`<0`: 白（石に書かれた値は点数、反転で倍化）
- **Field**（不変）:
  - `Cells`: 読み取り専用配列（コピー + freeze）
  - `Turn`: 手番（`1 | -1`）
  - `Place(index)`: 合法なら石を置き、挟んだ相手石を反転（符号反転 + 倍化）
  - `ListLegalMoves()`, `CanPlace()`, `Pass()`, `HasAnyMove*()`
  - `Score()`: 黒/白の合計点
  - `IsEndByScore()`: どちらかが1000点以上で終了

## AI（AlphaBeta）
- `thinkAlphaBeta(field, depth, ...)` / `thinkGreedy`
- **評価**:
  - ポイント到達（1000点）を強く反映
  - 地形重み（8x8のみ `scoreMap`）は石の符号のみで加点/減点
  - 簡易評価 `evaluateEasy`（総和のみ）は低レベルで使用

## リプレイ実装
- **起動**: URL パラメータを `GameRoot` が解釈 → `ReplayElement` を表示
- **進行**: `use-timer` の tick で1手ずつ `Field.Place()` を適用
- **自動パス**: ログ上の手が一時的に打てない場合、合法手が無ければ `Pass()` を挿入
- **オーバーレイ**: 青ティント + 走査線（`repeating-linear-gradient`）+ 左上に白い ▶（点滅）
- **終了**: ログ適用完了 → 即座に終了画面へ。REPLAY で同一ログを先頭から再生
- **生成**: 通常対局の終了画面から `buildReplayUrl/buildReplayQuery` でURL遷移（同一ならreload）

## ロジック方針
- ゲームロジックを扱うClassは自身の状態を絶対に変更しない。各メソッドは新しいインスタンスを返す。


## UI方針
- **イベント**: JSXの `onClick` などは1行で収まらない処理はハンドラ関数に切り出し
- **分離**: パネル/オーバーレイはプレゼンテーション専用。ロジックは `PlayElement`/`ReplayElement` に閉じる
- **色/演出**: 終了ボタン色は固定（NEW GAME=明るい紫, REPLAY=オレンジ）。走査線は太め・軽いぼかし

## ライブラリ/ユーティリティ
- **use-timer**: リプレイの等間隔ステップ
- `lib/replay`: `parseLog`（区切り `.`）, `stringifyLog`
- `lib/url`: `buildReplayUrl`, `buildReplayQuery`, `clearReplayParams`
- `lib/result`: 結果文言/色の決定
- `lib/labels`: AIレベル表示
- `lib/board`: 盤面演出用の補助（jitter強度）

## 開発メモ
- 互換性のため、URLからのリプレイ起動時に `player/level` は画面表示にも即時反映
- NEW GAME では `replay/player/level/log` を URL から除去（共有URLの誤用防止）
- 盤面クリックヒットテストは `FieldElement`（SVG座標→index変換）で実装
